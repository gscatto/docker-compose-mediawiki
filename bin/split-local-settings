#!/usr/bin/env -S sh -eu

main () {
    if local_settings_contain_public_and_private_parameters; then
        download_local_settings
        generate_public_local_settings
        generate_private_local_settings
        overwrite_local_settings
    fi
}

local_settings_contain_public_and_private_parameters () {
    docker compose exec php-fpm grep -q ^\$wgSitename /var/www/${MEDIAWIKI_HOST}/html/w/LocalSettings.php
}

download_local_settings () {
    docker compose cp php-fpm:/var/www/${MEDIAWIKI_HOST}/html/w/LocalSettings.php $TMP/local_settings
}

generate_public_local_settings () {
    sed -e '/^$wgDBpassword/d' -e '/^$wgSecretKey/d' -e '/^$wgUpgradeKey/d' $TMP/local_settings > mediawiki-private-extension/LocalSettings.php
}

generate_private_local_settings () {
    cat <<-EOF > $TMP/private_local_settings
<?php
$(grep ^\$wgDBpassword $TMP/local_settings)
$(grep ^\$wgSecretKey $TMP/local_settings)
$(grep ^\$wgUpgradeKey $TMP/local_settings)
require_once "\$IP/extensions/private/LocalSettings.php";
EOF
}

overwrite_local_settings () {
    docker compose cp $TMP/private_local_settings php-fpm:/var/www/${MEDIAWIKI_HOST}/html/w/LocalSettings.php
}

TMP=$(mktemp -d)
main
rm -r $TMP

